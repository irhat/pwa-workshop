<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>PWA Workshop | 5. Background sync et notifications</title>
    <meta name="description" content="Introduction aux Progressive Web Applications">
    <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="application-name" content="PWA Workshop Docs">
  <meta name="apple-mobile-web-app-title" content="PWA Workshop Docs">
    
    <link rel="preload" href="/assets/css/0.styles.b27e0b11.css" as="style"><link rel="preload" href="/assets/js/app.f2fa879a.js" as="script"><link rel="preload" href="/assets/js/3.647747c2.js" as="script"><link rel="prefetch" href="/assets/js/1.f1db8612.js"><link rel="prefetch" href="/assets/js/2.14c9a69d.js"><link rel="prefetch" href="/assets/js/4.5b1fb5a1.js"><link rel="prefetch" href="/assets/js/5.fba38f3f.js"><link rel="prefetch" href="/assets/js/6.0018bc76.js"><link rel="prefetch" href="/assets/js/7.1f9882ea.js"><link rel="prefetch" href="/assets/js/8.33b2fcd3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b27e0b11.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      PWA Workshop
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><!----></div></header><div class="sidebar-mask"></div><div class="sidebar"><!----><ul class="sidebar-links"><li><a href="/" class="sidebar-link">Introduction</a></li><li><a href="/1-manifest/" class="sidebar-link">1. Ajout d'un Web App Manifest</a></li><li><a href="/2-service-worker/" class="sidebar-link">2. Installation d'un Service Worker</a></li><li><a href="/3-precaching/" class="sidebar-link">3. Precaching et mode offline basique</a></li><li><a href="/4-api-cache/" class="sidebar-link">4. Stratégie de Cache pour API REST</a></li><li><a href="/5-background-sync/" class="active sidebar-link">5. Background sync et notifications</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/5-background-sync/#notifications-et-permissions" class="sidebar-link">Notifications et permissions</a></li><li class="sidebar-sub-header"><a href="/5-background-sync/#synchronisation-en-tache-de-fond" class="sidebar-link">Synchronisation en tâche de fond</a></li><li class="sidebar-sub-header"><a href="/5-background-sync/#actualisation-et-notification" class="sidebar-link">Actualisation et notification</a></li><li class="sidebar-sub-header"><a href="/5-background-sync/#test-de-bon-fonctionnement" class="sidebar-link">Test de bon fonctionnement</a></li></ul></li><li><a href="/finish.html" class="sidebar-link">Pour aller plus loin</a></li></ul></div><div class="page"><div class="content"><h1 id="etape-5-background-sync-et-notifications"><a href="#etape-5-background-sync-et-notifications" aria-hidden="true" class="header-anchor">#</a> Etape 5 : Background sync et notifications</h1><p>Pour conclure ce workshop, nous allons mettre à profit le Service Worker et une nouvelle API, <strong>Background Sync</strong>, pour mettre à jour la liste des participants en tâche de fond et notifier l'utilisateur lorsqu'il y a des nouveaux participants.</p><div class="danger custom-block"><p class="custom-block-title">Non standard</p><p>L'API Background Sync n'est pas encore standardisée. La <a href="https://wicg.github.io/BackgroundSync/spec/" target="_blank" rel="noopener noreferrer">spécification</a> est toujours à l'étude. Elle est déjà implémentée sur Chrome et Android depuis 2016, et en cours de développement sur Edge et Firefox. Cette API distingue deux types de synchronisation: <em>One-Time</em> et <em>Périodique</em>. Actuellement, seule la synchronisation <strong>One-Time</strong> est implémentée dans Chrome, et il peut y avoir quelques bugs d'implémentation.</p></div><p>Concernant les notifications, L'API Push permet aux applications web de recevoir des notifications push poussées depuis un serveur, même lorsque l'application web n'est pas au premier plan et même lorsqu'elle n'est actuellement pas chargée sur l'agent utilisateur. Néanmoins, cela implique l’utilisation côté serveur d’un service de push tel que Google Cloud Messenger.</p><p>Dans le cadre de ce workshop, nous n'allons pas utiliser l'API Push mais l'<strong>API Notification</strong>. Cette API permet également d'envoyer des notifications sans nécessiter de partie serveur, mais requiert que le navigateur soit ouvert. Ces notifications sont multi-plateformes, elles s’adapteront donc à la plate-forme cible: notifications Android ou centre de notifications de Windows 10 par exemple.</p><h2 id="notifications-et-permissions"><a href="#notifications-et-permissions" aria-hidden="true" class="header-anchor">#</a> Notifications et permissions</h2><p>La synchronisation en tâche de fond ne nécessite pas de permissions particulières, en revanche afficher des notifications requiert le consentement de l'utilisateur. Pour éviter le spam, les navigateurs ont ajouté des contraintes à respecter pour pouvoir demander ces permissions. On peut par exemple le faire suite à une action de l'utilisateur comme le clic sur un lien.</p><p>Ajoutez donc le lien ci-dessous quelque-part dans la page <code>index.html</code> pour activer les notifications:</p><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>registerNotification()<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>Notify me when there are new attendees<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>
</code></pre><p>Puis déclarez la fonction suivante dans <code>scripts.js</code></p><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">registerNotification</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	Notification<span class="token punctuation">.</span><span class="token function">requestPermission</span><span class="token punctuation">(</span>permission <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>permission <span class="token operator">===</span> <span class="token string">'granted'</span><span class="token punctuation">)</span><span class="token punctuation">{</span> <span class="token function">registerBackgroundSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
		<span class="token keyword">else</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Permission was not granted.&quot;</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>Lorsque l'utilisateur aura donné sa permission d'afficher des notifications, nous appellerons la fonction <code>registerBackgroundSync</code> pour mettre en place la synchronisation en arrière-plan.</p><h2 id="synchronisation-en-tache-de-fond"><a href="#synchronisation-en-tache-de-fond" aria-hidden="true" class="header-anchor">#</a> Synchronisation en tâche de fond</h2><p>Le client doit explicitement s'inscrire aux tâches de synchronisation en tâche de fond. Pour ce faire, on commence par récupérer une référence à la <code>ServiceWorkerRegistration</code>, qui représente le lien d'enregistrement entre votre Service Worker et votre client. Le plus simple pour cela est d'utiliser <a href="https://developer.mozilla.org/en-US/docs/Web/API/ServiceWorkerContainer/ready" target="_blank" rel="noopener noreferrer"><code>navigator.serviceWorker.ready</code></a> qui retourne une <code>Promise</code> résolue avec la <code>ServiceWorkerRegistration</code> lorsque le Service Worker est installé et actif.</p><p>Une fois l'objet <code>registration</code> de type <code>ServiceWorkerRegistration</code> récupéré, nous pouvons appeler la méthode <code>registration.sync.register</code> pour s'inscrire à une tâche de synchronisation One-Time en arrière-plan.</p><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">registerBackgroundSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Service Worker not supported&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    navigator<span class="token punctuation">.</span>serviceWorker<span class="token punctuation">.</span>ready
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>registration <span class="token operator">=&gt;</span> registration<span class="token punctuation">.</span>sync<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'syncAttendees'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;Registered background sync&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>err <span class="token operator">=&gt;</span> console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Error registering background sync&quot;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>Côté Service Worker, un évènement de type <code>sync</code> sera émis lorsque le système décide de déclencher une synchronisation. Cette décision se base sur différents paramètres: la connectivité, l'état de la batterie, la source d'alimentation etc. ; ainsi nous ne pouvons pas être sûrs du moment où la synchronisation est déclenchée. La spécification prévoit des possibilités de paramétrage à terme, mais pour le moment, tout ce que nous pouvons faire est attendre. Toutefois, dans les conditions du workshop, cela ne devrait prendre que quelques secondes.</p><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'sync'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;sync event&quot;</span><span class="token punctuation">,</span> event<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>tag <span class="token operator">===</span> <span class="token string">'syncAttendees'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        event<span class="token punctuation">.</span><span class="token function">waitUntil</span><span class="token punctuation">(</span><span class="token function">syncAttendees</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// on lance la requête de synchronisation</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><h2 id="actualisation-et-notification"><a href="#actualisation-et-notification" aria-hidden="true" class="header-anchor">#</a> Actualisation et notification</h2><p>La requête de synchronisation est similaire à l'<code>update</code> et <code>refresh</code> de l'étape 4, à la différence qu'elle est faite à la demande du système et non du client:</p><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">syncAttendees</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">{</span> url<span class="token punctuation">:</span> <span class="token template-string"><span class="token string">`https://reqres.in/api/users`</span></span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
    	<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>refresh<span class="token punctuation">)</span>
    	<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>attendees<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> self<span class="token punctuation">.</span>registration<span class="token punctuation">.</span><span class="token function">showNotification</span><span class="token punctuation">(</span>
    		<span class="token template-string"><span class="token string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>attendees<span class="token punctuation">.</span>length<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> attendees to the PWA Workshop`</span></span>
    	<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><p>Si le client dispose de la permission d'afficher des notifications, la méthode <code>self.registration.showNotification</code> devrait afficher une notification avec le texte désiré sur le client enregistré.</p><h2 id="test-de-bon-fonctionnement"><a href="#test-de-bon-fonctionnement" aria-hidden="true" class="header-anchor">#</a> Test de bon fonctionnement</h2><div class="warning custom-block"><p class="custom-block-title">Attention</p><p>Comme pour les étapes précédentes, assurez-vous que la case <strong>Update on reload</strong> est cochée dans les Developer Tools afin de toujours recharger la dernière version du Service Worker.</p></div><p>Au clic sur le lien d'activation des notifications, une demande de permission devrait s'afficher. Après avoir accepté, vous devriez observer dans la console le log <code>Registered background sync</code>. Il ne vous reste plus qu'à attendre que le système déclenche une synchronisation et affiche la notification, ce qui devrait prendre quelques secondes, 1 minute tout au plus. Si l'application web est au premier plan, la liste des participants devrait également être actualisée grâce à la fonction <code>refresh</code> dans <code>syncAttendees</code>.</p><p>Vous pouvez cliquer à nouveau sur le lien de notification pour demander une nouvelle requête de synchronisation.</p></div><!----><div class="content page-nav"><p class="inner"><span class="prev">
        ← <a href="/4-api-cache/" class="prev">
          4. Stratégie de Cache pour API REST
        </a></span><span class="next"><a href="/finish.html">
          Pour aller plus loin
        </a> →
      </span></p></div></div></div></div>
    <script src="/assets/js/3.647747c2.js" defer></script><script src="/assets/js/app.f2fa879a.js" defer></script>
  </body>
</html>
