<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>PWA Workshop | 2. Installation d&#39;un Service Worker</title>
    <meta name="description" content="Introduction aux Progressive Web Applications">
    <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="application-name" content="PWA Workshop Docs">
  <meta name="apple-mobile-web-app-title" content="PWA Workshop Docs">
    
    <link rel="preload" href="/assets/css/0.styles.b27e0b11.css" as="style"><link rel="preload" href="/assets/js/app.f2fa879a.js" as="script"><link rel="preload" href="/assets/js/6.0018bc76.js" as="script"><link rel="prefetch" href="/assets/js/1.f1db8612.js"><link rel="prefetch" href="/assets/js/2.14c9a69d.js"><link rel="prefetch" href="/assets/js/3.647747c2.js"><link rel="prefetch" href="/assets/js/4.5b1fb5a1.js"><link rel="prefetch" href="/assets/js/5.fba38f3f.js"><link rel="prefetch" href="/assets/js/7.1f9882ea.js"><link rel="prefetch" href="/assets/js/8.33b2fcd3.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b27e0b11.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      PWA Workshop
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><!----></div></header><div class="sidebar-mask"></div><div class="sidebar"><!----><ul class="sidebar-links"><li><a href="/" class="sidebar-link">Introduction</a></li><li><a href="/1-manifest/" class="sidebar-link">1. Ajout d'un Web App Manifest</a></li><li><a href="/2-service-worker/" class="active sidebar-link">2. Installation d'un Service Worker</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/2-service-worker/#enregistrement-du-service-worker" class="sidebar-link">Enregistrement du Service Worker</a></li><li class="sidebar-sub-header"><a href="/2-service-worker/#cycle-de-vie-du-service-worker" class="sidebar-link">Cycle de vie du Service Worker</a></li></ul></li><li><a href="/3-precaching/" class="sidebar-link">3. Precaching et mode offline basique</a></li><li><a href="/4-api-cache/" class="sidebar-link">4. Stratégie de Cache pour API REST</a></li><li><a href="/5-background-sync/" class="sidebar-link">5. Background sync et notifications</a></li><li><a href="/finish.html" class="sidebar-link">Pour aller plus loin</a></li></ul></div><div class="page"><div class="content"><h1 id="etape-2-installation-d-un-service-worker"><a href="#etape-2-installation-d-un-service-worker" aria-hidden="true" class="header-anchor">#</a> Etape 2 : Installation d'un Service Worker</h1><p>Le Service Worker est une API assez vaste et présentant beaucoup de potentiel. Dans le cadre d'une PWA, le Service Worker va principalement nous permettre de définir une stratégie de mise en cache et ainsi mieux gérer les connexions capricieuses, voire un mode offline complet pour notre application.</p><p>Voici quelques <a href="https://developers.google.com/web/fundamentals/primers/service-workers/" target="_blank" rel="noopener noreferrer">spécificités</a> des Service Workers:</p><ul><li>Ce sont des workers codés en JavaScript. Ils s'éxécutent dans un thread distinct du script applicatif et ne peuvent pas accéder au DOM ni aux variables globales, mais l'application peut communiquer avec le worker grâce à l'API <code>postMessage</code>.</li><li>Ce sont des proxy réseau programmables. En effet, ils permettent d'intercepter les requêtes réseau en partance du navigateur et de personnaliser leurs réponses.</li><li>Ils ont un cycle de vie indépendant de l'application web associée. Ils s'arrêtent lorsqu'ils ne sont pas utilisés et redémarrent au besoin.</li><li>Ils peuvent fonctionner sans que l'application web associée tourne, ce qui permet certaines fonctionnalités inédites comme l'envoi de notifications Push.</li><li>Plusieurs API sont disponibles au sein du Service Worker pour persister les données localement, par exemple l'<a href="https://developer.mozilla.org/fr/docs/Web/API/Cache" target="_blank" rel="noopener noreferrer"><strong>API Cache</strong></a> et l'<a href="https://developer.mozilla.org/fr/docs/Web/API/API_IndexedDB" target="_blank" rel="noopener noreferrer"><strong>API IndexedDB</strong></a>.</li><li>La plupart des API associées sont basées sur l'utilisation des promesses (<a href="https://developer.mozilla.org/fr/docs/Web/JavaScript/Reference/Objets_globaux/Promise" target="_blank" rel="noopener noreferrer"><code>Promise</code></a>).</li></ul><p>Dans le dossier <code>app</code>, créez un fichier <code>sw.js</code> vide (pour l'instant). Il contiendra le code de votre Service Worker.</p><h2 id="enregistrement-du-service-worker"><a href="#enregistrement-du-service-worker" aria-hidden="true" class="header-anchor">#</a> Enregistrement du Service Worker</h2><p>Avant d'utiliser un Service Worker, il faut le faire enregistrer par l'application. On enregistre généralement le Service Worker au chargement de la page. Dans le fichier <code>scripts.js</code>, complétez la fonction appelée au chargement du document avec le code suivant :</p><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">'serviceWorker'</span> <span class="token keyword">in</span> navigator<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  navigator<span class="token punctuation">.</span>serviceWorker
    <span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span><span class="token string">'/sw.js'</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>serviceWorker <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Service Worker registered: '</span> <span class="token operator">+</span> serviceWorker<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token keyword">catch</span><span class="token punctuation">(</span>error <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Error registering the Service Worker: '</span> <span class="token operator">+</span> error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>Avant de rafraichir la page, Rechargez la page, le log suivant devrait apparaitre une fois la page chargée.</p><pre class="language-text"><code>Service Worker registered: [object ServiceWorkerRegistration]
</code></pre><p>Cela signifie que le Service Worker a bien été enregistré. On peut vérifier cela grâce à l'onglet <strong>Application</strong> des ChromeDev tools.</p><p><img src="/assets/img/service-worker-setup.84b2c4b3.png" alt="Service Worker bien installé" title="Cycle de vie du Service Worker"></p><p>Nous allons voir dans le section qui suite ce qui se passe après l'enregistrement d'un Service Worker.</p><h2 id="cycle-de-vie-du-service-worker"><a href="#cycle-de-vie-du-service-worker" aria-hidden="true" class="header-anchor">#</a> Cycle de vie du Service Worker</h2><p>Quand on enregistre un Service Worker, son cycle de vie démarre. Le schéma suivant représente les différentes étapes du cycle de vie d'un Service Worker (<a href="https://developers.google.com/web/fundamentals/primers/service-workers/" target="_blank" rel="noopener noreferrer">source</a>).</p><p><img src="/assets/img/sw-lifecycle.1d49eede.png" alt="Cycle de vie du Service Worker" title="Cycle de vie du Service Worker"></p><p>Les premières étapes sont l'installation et l'activation. Vérifions cela en ajoutant le code suivant dans le fichier <em>sw.js</em>.</p><pre class="language-js"><code>self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'install'</span><span class="token punctuation">,</span> event <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Service Worker installing.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

self<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'activate'</span><span class="token punctuation">,</span> event <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Service Worker activating.'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><p>Rechargez la page et vérifier les logs. Tiens, on ne voit que le log d'installation.</p><pre class="language-text"><code>Service Worker registered [object ServiceWorkerRegistration]
Service Worker installing.
</code></pre><p>Vérifions, l'écran Service Worker des devtools. Un affichage similaire à la capture suivante devrait apparaitre:</p><p><img src="/assets/img/sw-waiting.0b9f4663.png" alt="Service Worker en attente d'installation" title="Service Worker en attente"></p><p>Quand on rafraîchit la page, le navigateur essaie d'installer puis d'activer un nouveau Service Worker. Comme ce dernier est différent du Service Worker actif, son activation est suspendue. Dans ce cas, Il entre en attente et ne sera installé que si le précédent Service Worker ne contrôle aucun client. On a deux solutions dans ce cas: soit fermer tous les onglets controlés par le premier Service Worker ou bien cliquer sur le lien <strong>skipWaiting</strong>.</p><p>Cliquez sur le lien <strong>skipWaiting</strong>. On remarque que l'ancien Service Worker a disparu et que celui qui était en attente prend sa place. Le log d'activation s'affiche également.</p><pre class="language-text"><code>Service Worker activating.
</code></pre><p>Quand on rafraîchit la page sans modifier le Service Worker, on remarque qu'on ne passe plus par les étapes d'installation et d'activation.</p><p>On peut comprendre qu'il est nécessaire de gérer en production la montée en version des Service Workers. En développement, on peut s'en passer en cochant la case <strong>Update on reload</strong>. Cette option permet d'activer immédiatement les futurs nouveaux Service Workers. C'est un équivalent d'un clic automatique sur <strong>skipWaiting</strong> à chaque fois.</p><div class="tip custom-block"><p class="custom-block-title">Note</p><p>Activez l'option <strong>Update on reload</strong> lorsque vous travaillez sur le code d'un Service Worker pour toujours disposer de la dernière version. Attention toutefois, cette option installera et activera le Service Worker <strong>avant</strong> d'afficher la page, ce qui ne vous permettra pas de voir les logs associés à ces évènements en console.</p></div><p>Dans cette partie, nous avons vu comment installer un Service Worker. On a également géré deux évènements du cycle de vie du Service Worker: <strong>install</strong> et <strong>activate</strong>. Nous allons maintenant voir comment faire quelque-chose d'utile avec ce Service Worker.</p></div><!----><div class="content page-nav"><p class="inner"><span class="prev">
        ← <a href="/1-manifest/" class="prev">
          1. Ajout d'un Web App Manifest
        </a></span><span class="next"><a href="/3-precaching/">
          3. Precaching et mode offline basique
        </a> →
      </span></p></div></div></div></div>
    <script src="/assets/js/6.0018bc76.js" defer></script><script src="/assets/js/app.f2fa879a.js" defer></script>
  </body>
</html>
